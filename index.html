<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Church Tour</title>
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: Arial, sans-serif; overflow: hidden; }
        #pano { width: 100vw; height: 100vh; position: relative; }
        #loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; z-index: 10; }
        #progress { width: 200px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; margin: 10px auto; }
        #progress-bar { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        #nav { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 5; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 10px; display: flex; gap: 10px; }
        .thumb { width: 60px; height: 40px; background-size: cover; border-radius: 5px; cursor: pointer; opacity: 0.7; transition: opacity 0.3s; }
        .thumb.active { opacity: 1; border: 2px solid #4CAF50; }
        #autorotate-btn { position: absolute; top: 20px; right: 20px; z-index: 5; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 16px; }
        #autorotate-btn:hover { background: rgba(0,0,0,0.8); }
        #info-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 10px; max-width: 300px; z-index: 20; display: none; }
        .hotspot { position: absolute; width: 20px; height: 20px; background: url('images/hotspot-icon.png') no-repeat center; background-size: contain; cursor: pointer; z-index: 15; }
        /* Custom compass/tripod logo */
        #compass { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 60px; height: 60px; background: url('images/logo.png') no-repeat center; background-size: contain; z-index: 5; opacity: 0.8; transition: opacity 0.3s; pointer-events: none; }
        #compass:hover { opacity: 1; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marzipano@0.5.1/build/marzipano.min.js"></script>
</head>
<body>
    <div id="pano"></div>
    <div id="loading">
        <div>Loading...</div>
        <div id="progress"><div id="progress-bar"></div></div>
    </div>
    <button id="autorotate-btn">⏸️</button>
    <div id="compass"></div> <!-- Logo in tripod circle -->
    <div id="nav"></div>
    <div id="info-popup">
        <h3 id="popup-title"></h3>
        <p id="popup-text"></p>
        <button onclick="closePopup()">Close</button>
    </div>

    <script>
        // Scene config - Customize these!
        const scenes = {
            sanctuary: {
                title: 'Sanctuary',
                image: 'images/sanctuary.jpg',
                hotspots: [
                    { pitch: 0.3, yaw: 0.5, type: 'scene', target: 'lobby', label: 'To Lobby' },
                    { pitch: -0.2, yaw: -0.8, type: 'info', title: 'Main Altar', text: 'This is the heart of our worship space, seating 200+.' }
                ],
                thumb: 'images/sanctuary-thumb.jpg' // Low-res preview
            },
            lobby: {
                title: 'Lobby',
                image: 'images/lobby.jpg',
                hotspots: [
                    { pitch: 0.1, yaw: 1.0, type: 'scene', target: 'sanctuary', label: 'To Sanctuary' },
                    { pitch: 0.4, yaw: 0.2, type: 'info', title: 'Welcome Area', text: 'Gather here before services—coffee served Sundays!' }
                ],
                thumb: 'images/lobby-thumb.jpg'
            },
            altar: {
                title: 'Altar Close-Up',
                image: 'images/altar.jpg',
                hotspots: [
                    { pitch: -0.1, yaw: -0.3, type: 'scene', target: 'lobby', label: 'Back to Lobby' }
                ],
                thumb: 'images/altar-thumb.jpg'
            }
        };

        let viewer, currentScene = 'sanctuary';
        let autorotate = null;
        const initialView = { yaw: 0, pitch: 0, hfov: 100 };

        // Create viewer
        const panoElement = document.getElementById('pano');
        viewer = new Marzipano.Viewer(panoElement, {
            controls: { mouse: true, touch: true },
            defaultViewController: true
        });

        // Load first scene
        loadScene(currentScene);

        // Scene loader with progress
        function loadScene(sceneId) {
            const scene = scenes[sceneId];
            Marzipano.ImageUrlSource.fromString(scene.image, { cubeMapPreviewUrl: null })
                .then(source => {
                    const geometry = new Marzipano.CubeGeometry([{ faces: 6 }]);
                    const limiter = Marzipano.util.compose(
                        Marzipano.DomUtil.getScreenEdgeBias(),
                        Marzipano.RectangleLimiter({ x: [-Math.PI, Math.PI], y: [-Math.PI/2, Math.PI/2] })
                    );
                    const view = new Marzipano.RectilinearView(initialView, limiter);

                    const sceneObj = viewer.createScene(source, geometry, view);
                    sceneObj.lookTo(initialView.yaw, initialView.pitch, initialView.hfov);

                    // Hotspots
                    scene.hotspots.forEach(hotspot => {
                        const element = document.createElement('div');
                        element.className = 'hotspot';
                        element.style.left = (0.5 + hotspot.yaw / (Math.PI * 2)) * 100 + '%';
                        element.style.top = (0.5 - hotspot.pitch / Math.PI) * 100 + '%';
                        element.onclick = () => {
                            if (hotspot.type === 'scene') {
                                switchScene(hotspot.target, { transition: 'fade' });
                            } else if (hotspot.type === 'info') {
                                showPopup(hotspot.title, hotspot.text);
                            }
                        };
                        panoElement.appendChild(element);
                    });

                    // Progress bar
                    source.onProgress(0, 1); // Fake start
                    source.onProgress = (loaded, total) => {
                        document.getElementById('progress-bar').style.width = (loaded / total * 100) + '%';
                        if (loaded === total) setTimeout(() => document.getElementById('loading').style.display = 'none', 500);
                    };

                    viewer.setScene(sceneObj);
                    updateThumbs(sceneId);
                    startAutorotate();
                })
                .catch(err => console.error('Load error:', err));
        }

        // Switch scenes with fade
        function switchScene(sceneId, options = {}) {
            const fadeTime = options.transition === 'fade' ? 1000 : 0;
            viewer.switchSceneWithTransition(loadScene.bind(null, sceneId), { transition: 'crossFade', duration: fadeTime });
            currentScene = sceneId;
        }

        // Thumbnail nav
        function updateThumbs(activeId) {
            const nav = document.getElementById('nav');
            nav.innerHTML = '';
            Object.keys(scenes).forEach(id => {
                const thumb = document.createElement('div');
                thumb.className = 'thumb';
                thumb.style.backgroundImage = `url(${scenes[id].thumb})`;
                thumb.onclick = () => switchScene(id);
                if (id === activeId) thumb.classList.add('active');
                nav.appendChild(thumb);
            });
        }

        // Autorotate
        function startAutorotate() {
            if (autorotate) autorotate.stop();
            autorotate = viewer.addControl(Marzipano.util.simpleAutorotate(0.002)); // Slow rotate
            document.getElementById('autorotate-btn').textContent = '⏸️';
        }
        function toggleAutorotate() {
            if (autorotate) {
                autorotate.stop();
                autorotate = null;
                document.getElementById('autorotate-btn').textContent = '▶️';
            } else {
                startAutorotate();
            }
        }
        document.getElementById('autorotate-btn').onclick = toggleAutorotate;

        // Info popup
        function showPopup(title, text) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-text').textContent = text;
            document.getElementById('info-popup').style.display = 'block';
        }
        function closePopup() {
            document.getElementById('info-popup').style.display = 'none';
        }

        // Mobile tweaks
        if ('ontouchstart' in window) {
            viewer.controls().enableTouch();
        }
    </script>
</body>
</html>